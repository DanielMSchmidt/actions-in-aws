# Drizzle Migrations

This directory contains the SQL migration files generated by `drizzle-kit` for the TODO List Lambda project.

## Purpose

Keeping migration SQL under version control ensures:
- Deterministic, reproducible database state across environments (dev / staging / prod).
- Traceability for every schema change (auditing & rollbacks).
- Easier code reviews of schema evolution.

## Workflow

Typical lifecycle when you change the schema in `src/schema.ts`:

1. Edit the Drizzle schema (e.g., add a column to `todos`).
2. Generate a new migration:
   ```bash
   npm run generate
   ```
3. Review the generated SQL here (make adjustments if truly necessary).
4. Apply migrations locally (or in CI/CD) to bring the database up to date:
   ```bash
   npm run migrate
   ```
5. Commit BOTH:
   - The updated `src/schema.ts`
   - The new SQL migration file(s) in this directory

## File Naming

`drizzle-kit` creates timestamped SQL files, e.g.:

```
0000_brisk_snake.sql
0001_add_completed_index.sql
```

Do not manually rename them after generation—order matters.

## Rollbacks

By default, `drizzle-kit` generates forward migrations only. If you need rollbacks:
- Create a compensating migration that reverses the change.
- OR maintain a manual rollback script separately.

## Deployment Strategy

In CI/CD (e.g., before publishing a new Lambda version):
1. Build application
2. Run `npm run migrate` against the target database (or a migration job/container)
3. Publish / update Lambda after schema is confirmed migrated

Never rely on the Lambda function itself to auto-run migrations on cold start—this can:
- Cause race conditions
- Increase cold start latency
- Fail under least-privilege IAM policies

## Safety Tips

- Avoid destructive changes (dropping columns/tables) without a deprecation window.
- Prefer additive changes + backfilling data, then remove old columns later.
- Always test migrations against a staging snapshot before production.
- Keep this directory clean: only generated SQL + this README (ignore caches / JSON artifacts).

## Troubleshooting

Issue: A migration failed midway.
- Investigate the DB state: some statements might have applied.
- Create and apply a follow-up migration to reconcile state.
- Avoid editing previously committed migration files retroactively.

Issue: Generated SQL not matching expectations.
- Re-check the schema definitions.
- Regenerate (`npm run generate`).
- If still wrong, you can hand-edit the SQL carefully—but document why in the PR.

## Do Not Commit

The `.gitignore` configuration excludes:
- `drizzle/*.json`
- `drizzle/.cache/`

These are build artifacts and not required for deployment.

---

Happy migrating!